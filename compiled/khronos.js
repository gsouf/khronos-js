var KhronosJs={handler:{}};KhronosJs.handler.sortDateAsc=function(a,b){return a.date>b.date?1:a.date<b.date?-1:0};KhronosJs.handler.sortDateDesc=function(a,b){return a.date>b.date?-1:a.date<b.date?1:0};KhronosJs.config=function(a){this.unit=a.unit;this.min=a.min;this.max=a.max;this.minY=a.minY;this.maxY=a.maxY;this.ppuX=a.ppuX;this.ppuY=a.ppuY;this._unittype;this._unitvalue;this._parseUnit()};
KhronosJs.config.prototype={SECOND:"s",MINUTE:"i",HOUR:"h",DAY:"d",WEEK:"w",MONTH:"m",YEAR:"y",_parseUnit:function(){var a=this.unit.slice(-1);switch(a){case "s":case "i":case "h":case "d":case "w":case "m":case "y":this._unittype=a;break;default:console.log("unknow type : '"+a+"' for unit. 'd' (day) used instead"),this._unittype="d"}this._unitvalue=this.unit.slice(0,-1)},diffX:function(a,b){void 0===b&&(b=!0);var c=this.unitToMs();return(a.getTime()-this.min.getTime())/c*(!0===b?this.ppuX:1)},diffXToDate:function(a){var b=
this.unitToMs();return new Date(a/this.ppuX*b+this.min.getTime())},unitToMs:function(){var a;switch(this._unittype){case "s":a=1E3;break;case "i":a=6E4;break;case "h":a=36E5;break;case "d":a=864E5;break;case "w":a=6048E5;break;case "m":a=2592E6;break;case "y":a=31536E6;break;default:console.log("unknow type : '"+unitchar+"' for unit. d (day) used instead")}return a},yVal:function(a){return(a-this.minY)*this.ppuY},getFirstDate:function(){return new Date(this.min.getTime())},moveToNext:function(a){a.setMilliseconds(a.getMilliseconds()+
this.unitToMs())}};KhronosJs.timegraph=function(a){Kinetic.Stage.apply(this,[a]);this.timelines=[];this.config=a.config;this.bgColor=a.bgColor;this.gridsColor=a.gridsColor;this.setHeight(this.config.yVal(this.config.maxY)+40);var b=this;this.backgroundLayer=new Kinetic.Layer;this.graphLayer=new Kinetic.Layer({y:3,height:this.height,width:this.width});this.labelGroup=new Kinetic.Group;this.labelsContainer=new Kinetic.Group;this.valuesGroup=new KhronosJs.valuePannel(this.config);this.positionGroupe=new Kinetic.Group;
this.graphGroupe=new Kinetic.Group;this.fullGraphGroup=new Kinetic.Group;this.gridGroup=new KhronosJs.dateGrid(this.config,{gridsColor:this.gridsColor});this.lineGroup=new Kinetic.Group;this.dateGroup=new KhronosJs.datePannel(this.config);a=new Kinetic.Rect({fill:a.bgColor,x:0,y:0,height:this.getHeight(),width:this.getWidth()});this.backgroundLayer.add(a);this.add(this.backgroundLayer);this.labelGroup.setHeight(this.getHeight());this.labelGroup.setWidth(120);a=new Kinetic.Rect({fill:this.bgColor,
x:0,y:0,height:this.labelGroup.getHeight(),width:this.labelGroup.getWidth()});this.labelGroup.add(a);this.positionGroupe.setHeight(this.getHeight());this.positionGroupe.setWidth(0);this.positionGroupe.setX(this.getWidth()-this.positionGroupe.getWidth());a=new Kinetic.Rect({fill:this.bgColor,x:0,y:0,height:this.positionGroupe.getHeight(),width:this.positionGroupe.getWidth()});this.positionGroupe.add(a);this.graphGroupe.setHeight(this.getHeight());this.graphGroupe.setWidth(this.getWidth()-this.positionGroupe.getWidth()-
this.labelGroup.getWidth());this.graphGroupe.setX(this.labelGroup.getWidth());this.fullGraphGroup.setHeight(this.graphGroupe.getHeight());this.fullGraphGroup.setWidth(this.config.diffX(this.config.max));this.fullGraphGroup.setX(0);this.fullGraphGroup.setDraggable(!0);this.fullGraphGroup.setDragBoundFunc(function(a){var c=a.x-b.graphGroupe.getX();a=10<c||c<-1*this.getWidth()+b.graphGroupe.getWidth()?this.getAbsolutePosition().x:a.x;b.refreshLabelPos();return{x:a,y:this.getAbsolutePosition().y}});this.graphGroupe.add(this.fullGraphGroup);
a=new Kinetic.Rect({fill:this.bgColor,x:0,y:0,height:this.fullGraphGroup.getHeight(),width:this.config.diffX(this.config.max)});this.fullGraphGroup.add(a);this.dateGroup.setHeight(40);this.dateGroup.setY(this.fullGraphGroup.getHeight()-this.dateGroup.getHeight());this.fullGraphGroup.add(this.dateGroup);this.fullGraphGroup.add(this.gridGroup);this.fullGraphGroup.add(this.lineGroup);a=new Kinetic.Line({points:[this.labelGroup.getWidth(),0,this.labelGroup.getWidth(),this.fullGraphGroup.getHeight()-this.dateGroup.getHeight()],
stroke:"#BBB",strokeWidth:1});var c=new Kinetic.Line({points:[0,0,0,this.fullGraphGroup.getHeight()-this.dateGroup.getHeight()],stroke:"#BBB",strokeWidth:1});this.valuesGroup.setX(this.labelGroup.getWidth()-12);this.graphLayer.add(this.graphGroupe);this.graphLayer.add(this.positionGroupe);this.graphLayer.add(this.labelGroup);this.labelGroup.add(a);this.labelGroup.add(this.valuesGroup);this.positionGroupe.add(c);this.labelGroup.add(this.labelsContainer);this.gridTime=new KhronosJs.dateGrid(this.config);
this.add(this.graphLayer);console.log(this.fullGraphGroup.getWidth())};
KhronosJs.timegraph.prototype={addTimeline:function(a){this.timelines.push(a);this.lineGroup.add(a.getGroup());this.refreshTimeline(a);this.draw()},refresh:function(){this.labelsContainer.removeChildren();for(var a in this.timelines)this.refreshTimeline(this.timelines[a]);this.draw()},refreshLabelPos:function(){var a=this.config.diffXToDate(Math.abs(this.fullGraphGroup.getX())),b;for(b in this.timelines)this.timelines[b].refreshLabelPos(a,this.config)},refreshTimeline:function(a){a.draw(this.config);
void 0!==a.legend&&(label=a.getLabel(),label.setX(this.labelGroup.getWidth()-20),this.labelsContainer.add(label),this.labelsContainer.draw(),a.refreshLabelPos(this.config.min,this.config))}};Kinetic.Global.extend(KhronosJs.timegraph,Kinetic.Stage);KhronosJs.point=function(a){this.date=a.date;this.value=a.value};KhronosJs.point.prototype={};KhronosJs.timeline=function(a){this.group=new Kinetic.Group;this.legend=a.legend;this.color=a.color;this.overColor=a.overColor;this.points=[];var b=this;this.group.on("mouseenter",function(){b.recolor(b.overColor)});this.group.on("mouseleave",function(){b.recolor(b.color)});this.label=new Kinetic.Label({text:{text:this.legend,fontFamily:"Arial",fontSize:10,fontStyle:"bold",padding:2,fill:"white"},rect:{fill:this.color,pointerDirection:"right",pointerWidth:3,pointerHeight:5}})};
KhronosJs.timeline.prototype={getGroup:function(){return this.group},getLabel:function(){return this.label},refreshLabelPos:function(a,b){var c=this.points[0],d=c,e=this.points[this.points.length-1];if(a.getTime()<=c.date.getTime())this.label.setY(b.yVal(c.value));else if(a.getTime()>=e.date.getTime())this.label.setY(b.yVal(e.value));else{for(e=0;e<this.points.length&&d.date<a;)this.points[e].date.getTime()<=a.getTime()&&(c=this.points[e],this.points[e+1].date>a&&(d=this.points[e+1])),e++;e=b.diffX(d.date,
!1)-b.diffX(c.date,!1);d=(d.value-c.value)/e;this.label.setY(b.yVal(c.value)+b.yVal((b.diffX(a,!1)-b.diffX(c.date,!1))*d))}},addPoint:function(a,b){a instanceof KhronosJs.point?this.points.push(a):this.points.push(new KhronosJs.point({date:a,value:b}))},draw:function(a){this.group.removeChildren();this.points.sort(KhronosJs.handler.sortDateAsc);var b=null,c;for(c in this.points){var d=this.points[c],e=a.diffX(d.date),d=new Kinetic.Rect({x:e-2.5,y:a.yVal(d.value),width:5,height:5,fill:this.color,strokeWidth:0});
null!==b&&(b=new Kinetic.Line({points:[b.getX()+b.getWidth()/2,b.getY()+b.getHeight()/2,d.getX()+d.getWidth()/2,d.getY()+d.getHeight()/2],stroke:this.color,strokeWidth:2,lineCap:"round",lineJoin:"round"}),this.group.add(b));b=d;this.group.add(d)}},recolor:function(a){var b=this.group.children,c;for(c in b)b[c]instanceof Kinetic.Line?b[c].setStroke(a):b[c].setFill(a);this.group.getParent().draw()}};KhronosJs.dateGrid=function(a,b){void 0===b&&(b={});Kinetic.Group.apply(this,[b]);this.config=a;this.gridsColor=void 0!==b.gridsColor?b.gridsColor:"#DDDDDD0";this.refresh()};
KhronosJs.dateGrid.prototype={refresh:function(){this.removeChildren();for(var a=this.config.diffX(this.config.max,!1),b=this.config.yVal(this.config.maxY),c=0;c<a+1;c++){var d=c*this.config.ppuX,d=new Kinetic.Line({points:[d,0,d,b],stroke:this.gridsColor,strokeWidth:1});this.add(d)}a*=this.config.ppuX;for(c=this.config.minY;c<this.config.maxY+1;c++)b=this.config.yVal(c),d=new Kinetic.Line({points:[0,b,a,b],stroke:this.gridsColor,strokeWidth:1}),this.add(d)}};
Kinetic.Global.extend(KhronosJs.dateGrid,Kinetic.Group);KhronosJs.datePannel=function(a,b){void 0===b&&(b={});Kinetic.Group.apply(this,[b]);this.config=a;this.font=void 0===b.font?"Arial":b.font;this.refresh()};
KhronosJs.datePannel.prototype={refresh:function(){this.removeChildren();for(var a=this.config.diffX(this.config.max,!1),b=this.config.getFirstDate(),c=0;c<a+1;c++){if(30>this.config.ppuX){if(2!==c%5){this.config.moveToNext(b);continue}}else if(60>this.config.ppuX&&1!==c%3){this.config.moveToNext(b);continue}var d=c*this.config.ppuX,e=new Kinetic.Text({x:d-15,y:15,text:b.getDate()+"-"+b.getMonth()+"-"+(b.getFullYear()+"").slice(-2),fontSize:10,fontFamily:this.font,fill:"#666666"}),d=new Kinetic.Line({points:[d,
0,d,7],stroke:"#BBB",strokeWidth:1});this.add(d);this.add(e);this.config.moveToNext(b)}}};Kinetic.Global.extend(KhronosJs.datePannel,Kinetic.Group);KhronosJs.valuePannel=function(a,b){void 0===b&&(b={});Kinetic.Group.apply(this,[b]);this.config=a;this.font=void 0===b.font?"Arial":b.font;this.refresh()};KhronosJs.valuePannel.prototype={refresh:function(){this.removeChildren();for(var a=this.config.minY;a<this.config.maxY+1;a++){var b=this.config.yVal(a),b=new Kinetic.Text({x:0,y:b,text:a,fontSize:10,fontFamily:this.font,fill:"#CCC"});this.add(b)}}};Kinetic.Global.extend(KhronosJs.valuePannel,Kinetic.Group);
